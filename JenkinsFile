pipeline {
    agent {
        docker {
            image 'golang:1.24.1'
            args '-u root'
        }
    }

    environment {
        HOME = '/go'
        GO111MODULE = 'on'
    }

    stages {
        stage('Lint') {
            steps {
                echo 'Running gofmt and golint...'
                sh '''
                    go install golang.org/x/lint/golint@latest

                    UNFORMATTED=$(gofmt -l .)
                    if [ -n "$UNFORMATTED" ]; then
                        echo "The following files are not formatted:"
                        echo "$UNFORMATTED"
                        exit 1
                    fi

                    golint ./... | tee lint-report.txt
                    if grep -q . lint-report.txt; then
                        echo "Lint issues found"
                        exit 1
                    fi
                '''
            }
        }
        stage('Test') {
            steps {
                echo 'Running unit tests...'
                sh '''
                    go mod tidy
                    go test -v -cover ./...
                '''
            }
        }
        stage('Build') {
            steps {
                echo 'Building Go binary...'
                sh 'go build -o bin/todo-app main.go'
            }
        }
    }
}


// pipeline {
//     agent any

//     stages {
//         stage('Build') {
//             agent {
//                 docker {
//                     image 'golang:1.24.1'
//                     reuseNode true
//                     args '-u root' 
//                 }
//             }
//             steps {
//                 echo 'Building Go binary...'
//                 sh '''
//                     go version
//                     go mod tidy
//                     go build -o bin/todo-app main.go
//                     ls -la bin/
//                 '''
//             }
//         }
//     }
// }
